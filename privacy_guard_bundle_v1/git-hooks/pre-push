#!/usr/bin/env bash
set -euo pipefail

REAL_NAME="${DG_REAL_NAME:-}"
[[ -z "$REAL_NAME" ]] && exit 0

pattern="$(printf '%s' "$REAL_NAME" | sed 's/[.[\*^$(){}+?|\-]/\\&/g')"
range="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/null || echo "origin/main")"

if git log "$range".. --patch | grep -Eiq -- "$pattern"; then
  echo "ðŸš« Push blocked: leak detected in to-be-pushed commits." >&2
  exit 1
fi

echo "âœ… Pre-push: No leaks detected."
